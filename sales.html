<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TSG Revenue &amp; Invoicing</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f4f5f7;color:#1a1a2e;min-height:100vh}

  /* Shared nav */
  .top-nav{background:#000;display:flex;align-items:center;padding:0 32px;height:52px;gap:6px;border-bottom:1px solid #222}
  .top-nav .tn-logo{width:28px;height:28px;filter:invert(1) brightness(2);margin-right:12px}
  .top-nav a{font-size:13px;font-weight:600;color:#888;text-decoration:none;padding:6px 16px;border-radius:6px;transition:all .15s}
  .top-nav a:hover{color:#fff;background:rgba(255,255,255,.08)}
  .top-nav a.active{color:#000;background:#fff}
  .top-nav .tn-spacer{flex:1}
  .top-nav .tn-updated{font-size:11px;color:#555}

  .wrap{max-width:1200px;margin:0 auto;padding:24px 20px 40px}
  .card{background:#fff;border:1px solid #e0e0e0;border-radius:12px;padding:22px 24px}
  .sec-pill{display:inline-block;padding:3px 12px;border-radius:99px;font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
  .sec-title{font-size:16px;font-weight:700;color:#1a1a2e;line-height:1.3;margin-bottom:2px}
  .sec-sub{font-size:12px;color:#6b7280;line-height:1.4}
  .g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .g3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .g2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .g-ns{display:grid;grid-template-columns:2fr 1fr 1fr;gap:16px}
  .kpi{background:#fff;border:1px solid #e0e0e0;border-radius:10px;padding:14px 16px}
  .kpi-label{font-size:11px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px}
  .kpi-val{font-size:24px;font-weight:700;color:#1a1a2e;letter-spacing:-.02em;line-height:1.2}
  .kpi-sub{font-size:12px;color:#6b7280;margin-top:4px;line-height:1.3}
  .st-label{font-size:11px;color:#6b7280;text-transform:uppercase;letter-spacing:.4px;margin-bottom:3px;font-weight:600}
  .st-val{font-size:22px;font-weight:700;line-height:1.2}
  .st-unit{font-size:12px;font-weight:400}
  .b-row{border-radius:8px;padding:16px;margin-bottom:10px;border:1px solid}
  .b-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px}
  .b-name{display:flex;align-items:center;gap:8px}
  .b-name strong{font-weight:700;font-size:14px;color:#1a1a2e}
  .pill{display:inline-block;padding:2px 10px;border-radius:99px;font-size:11px;font-weight:600;line-height:18px}
  .pill-g{background:#dcfce7;color:#166534;border:1px solid #bbf7d0}
  .pill-r{background:#fef2f2;color:#991b1b;border:1px solid #fecaca}
  .pill-y{background:#fefce8;color:#854d0e;border:1px solid #fef08a}
  .pill-b{background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe}
  .bar-w{height:6px;background:#e5e7eb;border-radius:6px;position:relative;overflow:hidden}
  .bar-p{position:absolute;height:100%;border-radius:6px;opacity:.2}
  .bar-f{position:absolute;height:100%;border-radius:6px;transition:width .6s ease}
  .bar-lbl{display:flex;justify-content:space-between;margin-top:5px;font-size:11px;color:#6b7280}
  .logo{width:24px;height:24px;object-fit:contain;border-radius:6px;flex-shrink:0}
  .logo-lg{width:36px;height:36px}
  .tbl{width:100%;border-collapse:collapse;font-size:12px}
  .tbl th{text-align:right;padding:6px 8px;font-size:11px;color:#6b7280;font-weight:600;border-bottom:2px solid #e5e7eb;text-transform:uppercase;letter-spacing:.3px}
  .tbl th:first-child{text-align:left}
  .tbl td{padding:6px 8px;text-align:right;color:#374151;border-bottom:1px solid #f3f4f6}
  .tbl td:first-child{text-align:left;font-weight:500;color:#1a1a2e}
  .tbl tr:nth-child(even){background:#fafbfc}
  .tbl .hl{background:#fffbeb!important}
  .tbl .hl td{color:#92400e;font-weight:600}
  .tbl .bold td{font-weight:600;color:#1a1a2e}
  .detail-panel{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:12px 14px;margin-top:8px}
  .detail-panel summary{font-size:11px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:.4px;cursor:pointer;user-select:none}
  .detail-panel summary:hover{color:#374151}
  .detail-content{margin-top:8px;font-size:12px;color:#6b7280;line-height:1.5}
  .up{color:#16a34a;font-weight:600}
  .dn{color:#dc2626;font-weight:600}
  .ns{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);border-radius:12px;padding:24px;color:#fff}
  .ns-glass{background:rgba(255,255,255,.06);border-radius:8px;padding:16px;text-align:center}
  .hb{display:flex;align-items:center;gap:8px;margin-bottom:5px}
  .hb-l{width:52px;font-size:12px;flex-shrink:0}
  .hb-t{flex:1;height:20px;border-radius:4px;overflow:hidden;position:relative}
  .hb-f{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:8px;transition:width .5s ease}
  .hb-f span{font-size:10px;font-weight:600}
  .comb{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:14px 16px}
  .rk{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:12px;text-align:center}
  .rk-l{font-size:11px;color:#6b7280;text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px;font-weight:600}
  .rk-v{font-size:22px;font-weight:800}
  .rk-s{font-size:11px;color:#9ca3af;margin-top:2px}
  .gl-r{display:flex;justify-content:space-between;font-size:12px;padding:3px 0}
  .gl-r span:first-child{color:#6b7280}
  .rt{margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid #f3f4f6}
  .rt:last-of-type{border-bottom:none}
  .fx-b{display:flex;justify-content:space-between;align-items:center}
  .fx-c{display:flex;align-items:center;gap:8px}
  .wd{display:flex;align-items:center;gap:4px}
  .wd-d{width:5px;height:18px;border-radius:2.5px}
  .wd-lbl{font-size:11px;color:#9ca3af;margin-left:6px}
  .footer{text-align:center;padding:16px 0;font-size:11px;color:#9ca3af;line-height:1.6}
  .mb-8{margin-bottom:8px}.mb-10{margin-bottom:10px}.mb-16{margin-bottom:16px}.mb-20{margin-bottom:20px}
  .mt-8{margin-top:8px}.mt-12{margin-top:12px}.mt-16{margin-top:16px}
  .loading{display:flex;align-items:center;justify-content:center;min-height:60vh;font-size:14px;color:#6b7280}
  .spinner{width:24px;height:24px;border:3px solid #e5e7eb;border-top-color:#1a1a2e;border-radius:50%;animation:spin .8s linear infinite;margin-right:12px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .error-box{background:#fef2f2;border:1px solid #fecaca;color:#991b1b;padding:20px;border-radius:10px;font-size:13px;margin:40px auto;max-width:600px;text-align:center}
  @media(max-width:900px){.g4,.g-ns{grid-template-columns:repeat(2,1fr)}.g2{grid-template-columns:1fr}}
</style>
</head>
<body>

<nav class="top-nav" id="legacyNav" style="display:none"></nav>
<script src="/nav.js"></script>

<div class="wrap">
  <div id="loading" class="loading"><div class="spinner"></div>Loading from Airtable&hellip;</div>
  <div id="error"></div>
  <div id="app"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
var C={tsg:{color:"#2d6e0e",accent:"#CDE453",bg:"#f5fbe8",bd:"#dff1a8"},wll:{color:"#0891b2",accent:"#6BD4EC",bg:"#ecfbff",bd:"#b3e8f7"},nv:{color:"#FF0077",accent:"#ff3399",bg:"#fff0f6",bd:"#ffb3d9"}};
var LOGOS={tsg:"https://cdn.shopify.com/s/files/1/1070/8974/files/TSG-Logo-Roundel-Black.png?v=1772037610",wll:"https://cdn.shopify.com/s/files/1/1070/8974/files/WeLoveLEDs-640px--MASTER.png?v=1772124903",nv:"https://cdn.shopify.com/s/files/1/1070/8974/files/NV-Logo-640px--Grey_s-Stuff.png?v=1772124894"};
var FY_START_MONTH=12;

function f(n){return"\u00A3"+Math.round(Number(n)||0).toLocaleString("en-GB")}
function ps(n){return(n>0?"+":"")+n+"%"}
function po(a,b){if(!b)return 0;return Math.round(((a-b)/b)*100)}
function dl(v){var p=v>0;return'<span class="'+(p?"up":"dn")+'">'+(p?"\u25B2":"\u25BC")+" "+(p?"+":"")+v+"%</span>"}
function pl(s){var c=s==="Ahead"||s==="High"?"pill-g":s==="Behind"||s==="Low"?"pill-r":"pill-y";return'<span class="pill '+c+'">'+s+"</span>"}
function plb(s,bg,fg){return'<span class="pill" style="background:'+bg+";color:"+fg+";border:1px solid "+bg+'">'+s+"</span>"}
function secHdr(pt,pb,pf,t,s){return'<div style="margin-bottom:16px"><span class="sec-pill" style="background:'+pb+";color:"+pf+'">'+pt+"</span><div class=\"sec-title\">"+t+"</div>"+(s?'<div class="sec-sub">'+s+"</div>":"")+"</div>";}
function mkbar(val,max,color,proj){
  var pI=Math.min(val/max*100,100),pP=proj?Math.min(proj/max*100,100):pI;
  return'<div class="bar-w"><div class="bar-p" style="width:'+pP+"%;background:"+color+'"></div><div class="bar-f" style="width:'+pI+"%;background:"+color+'"></div></div><div class="bar-lbl"><span>Invoiced: '+Math.round(pI)+"% of target</span>"+(pP!==pI?"<span>Projected: "+Math.round(pP)+"%</span>":"<span>\u2713 Complete</span>")+"</div>";
}
// Horizontal bar chart — expects items with {l: label, v: value, h: highlight}
function hbar(items,mx,color,dark){
  var o="";items.forEach(function(it){
    var w=mx>0?(it.v/mx)*100:0;
    var fc=it.h?color:(dark?"#475569":"#d1d5db");
    var tc=it.h?(dark?"#0f172a":"#fff"):(dark?"#cbd5e1":"#fff");
    var lc=it.h?(dark?"#CDE453":"#1a1a2e"):(dark?"#94a3b8":"#6b7280");
    o+='<div class="hb"><span class="hb-l" style="color:'+lc+";font-weight:"+(it.h?700:400)+'">'+it.l+"</span>";
    o+='<div class="hb-t" style="background:'+(dark?"rgba(255,255,255,0.06)":"#e5e7eb")+'">';
    o+='<div class="hb-f" style="width:'+w+"%;background:"+fc+'">';
    if(w>30)o+='<span style="color:'+tc+'">'+f(it.v)+"</span>";
    o+="</div></div>";
    if(w<=30)o+='<span style="font-size:11px;color:'+(dark?"#94a3b8":"#6b7280")+'">'+f(it.v)+"</span>";
    o+="</div>";
  });return o;
}
function parseMY(my){
  if(!my)return null;
  var ms=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"];
  var parts=my.replace(/[-\s]+/g," ").trim().split(" ");
  if(parts.length<2)return null;
  var mi=ms.indexOf(parts[0].toLowerCase().substring(0,3));
  if(mi<0)return null;var yr=parseInt(parts[1]||parts[0]);
  if(yr<100)yr+=2000;if(isNaN(yr))return null;
  return{month:mi+1,year:yr,key:yr+"-"+String(mi+1).padStart(2,"0")};
}
function monthShort(m){return["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][m]}
function normConv(v){if(v===null||v===undefined)return 0;v=Number(v);if(v>0&&v<1)return Math.round(v*100);return Math.round(v);}

// FY helpers
function fyPos(month){return month>=12?month-12:month}
function fyStart(month,year){return month>=12?year:year-1}
function fyKeys(startYear,maxPos){
  var keys=[];
  for(var p=0;p<=maxPos;p++){var m=p===0?12:p,y=p===0?startYear:startYear+1;keys.push(y+"-"+String(m).padStart(2,"0"));}
  return keys;
}
function fyLabel(sy){return"FY"+sy%100+"/"+(sy+1)%100}

// ============================================================
function processData(raw){
  var D={};
  var now=new Date(),curMonth=now.getMonth()+1,curYear=now.getFullYear();
  var curKey=curYear+"-"+String(curMonth).padStart(2,"0");

  D.month=monthShort(curMonth);D.year=curYear;
  D.monthName=["","January","February","March","April","May","June","July","August","September","October","November","December"][curMonth];

  // Monthly Overview (latest record for current month)
  var ov=null;
  raw.overview.forEach(function(r){var p=parseMY(r.monthYear);if(p&&p.key===curKey)ov=r;});
  if(!ov&&raw.overview.length>0)ov=raw.overview[raw.overview.length-1];

  D.phase=ov?ov.phase:"Week ?";
  D.wdTotal=ov?ov.workingDaysTotal:20;D.wdDone=ov?ov.workingDaysCompleted:0;D.wdLeft=D.wdTotal-D.wdDone;
  D.monthComplete=D.wdDone>=D.wdTotal;
  D.tsgConf=ov?ov.tsgConfidence:"";D.tsgConfNote=ov?ov.tsgConfidenceNote:"";
  D.wllNote=ov?ov.wllPaceNote:"";D.nvNote=ov?ov.nvPaceNote:"";
  D.focus=ov?ov.weekFocus:"";D.optFocus=ov?ov.optionalFocus:"";
  D.tsgWipDue=ov?ov.tsgWipDue:null;D.tsgWipUndated=ov?ov.tsgWipUndated:null;D.tsgWipNextMonth=ov?ov.tsgWipNextMonth:null;
  D.hasWip=D.tsgWipDue!==null;

  // Index tables
  var invByKey={},convByKey={};
  raw.invoiced.forEach(function(r){var p=parseMY(r.monthYear);if(p)invByKey[p.key]=r;});
  raw.conversions.forEach(function(r){var p=parseMY(r.monthYear);if(p)convByKey[p.key]=r;});
  var allKeys=Object.keys(invByKey).sort();

  // Current month
  var curInv=invByKey[curKey]||{},curConv=convByKey[curKey]||{};
  D.tsgTgt=(ov?ov.tsgTarget:0)||curInv.tsgTarget||0;
  D.wllTgt=(ov?ov.wllTarget:0)||curInv.wllTarget||0;
  D.nvTgt=(ov?ov.nvTarget:0)||curInv.nvTarget||0;
  D.combTgt=D.tsgTgt+D.wllTgt+D.nvTgt;

  D.tsgInv=(ov&&ov.tsgInvoicedToDate)||curInv.tsg||0;
  D.wllInv=(ov&&ov.wllInvoicedToDate)||curInv.wll||0;
  D.nvInv=(ov&&ov.nvInvoicedToDate)||curInv.nv||0;
  D.combInv=D.tsgInv+D.wllInv+D.nvInv;

  // Projections
  if(D.monthComplete){
    D.tsgProj=D.tsgInv;D.wllProj=D.wllInv;D.nvProj=D.nvInv;
    D.wllDaily=D.wdTotal>0?D.wllInv/D.wdTotal:0;D.nvDaily=D.wdTotal>0?D.nvInv/D.wdTotal:0;D.wllNeed=0;
  }else if(D.wdDone>0){
    D.wllDaily=D.wllInv/D.wdDone;D.nvDaily=D.nvInv/D.wdDone;
    D.wllProj=Math.round(D.wllDaily*D.wdTotal);D.nvProj=Math.round(D.nvDaily*D.wdTotal);
    D.wllNeed=D.wllTgt>D.wllInv&&D.wdLeft>0?(D.wllTgt-D.wllInv)/D.wdLeft:0;
    D.tsgProj=D.hasWip?D.tsgInv+(D.tsgWipDue||0):Math.round((D.tsgInv/D.wdDone)*D.wdTotal);
  }else{D.wllDaily=0;D.nvDaily=0;D.wllProj=0;D.nvProj=0;D.tsgProj=0;D.wllNeed=0;}
  D.combProj=D.tsgProj+D.wllProj+D.nvProj;
  D.wllPace=D.wllProj>=D.wllTgt?"Ahead":"Behind";
  D.nvPace=D.nvProj>=D.nvTgt?"Ahead":"Behind";

  // New Sales
  D.nsVal=curConv.salesConfirmed||0;D.nsTgt=curConv.newSalesTarget||curInv.tsgNewSalesTarget||0;
  D.nsEnq=curConv.enquiries||0;D.nsOrd=curConv.orders||0;
  D.nsConv=normConv(curConv.convRate);D.nsMargin=normConv(curConv.margin);D.nsAov=curConv.aov||0;

  // New Sales history (same month, recent years) — FIX: use 'l' property for hbar
  D.nsHistory=[];
  for(var yb=curYear-4;yb<=curYear;yb++){
    var k=yb+"-"+String(curMonth).padStart(2,"0");var c=convByKey[k];
    if(c&&(c.salesConfirmed||c.enquiries||c.orders)){
      D.nsHistory.push({
        l:D.month+"-"+String(yb).slice(2),  // FIX: 'l' not 'yr'
        v:c.salesConfirmed||0,e:c.enquiries||0,o:c.orders||0,
        c:normConv(c.convRate),m:normConv(c.margin),aov:c.aov||0,
        h:yb===curYear
      });
    }
  }

  // Same-month invoiced history
  D.histMonth=[];
  allKeys.forEach(function(k){
    var parts=k.split("-");
    if(parseInt(parts[1])===curMonth){
      var r=invByKey[k],yr=parseInt(parts[0]),isCur=k===curKey;
      var t=isCur?D.combProj:(r.tsg||0)+(r.wll||0)+(r.nv||0);
      D.histMonth.push({l:isCur?D.month+"-"+String(yr).slice(2)+"*":D.month+"-"+String(yr).slice(2),v:t,t:t,tsg:isCur?D.tsgProj:(r.tsg||0),wll:isCur?D.wllProj:(r.wll||0),nv:isCur?D.nvProj:(r.nv||0),h:isCur,p:isCur});
    }
  });

  // Rankings
  var allTotals=[];
  allKeys.forEach(function(k){var r=invByKey[k],t=(r.tsg||0)+(r.wll||0)+(r.nv||0);if(k===curKey)t=D.combProj;allTotals.push({key:k,t:t});});
  allTotals.sort(function(a,b){return b.t-a.t});
  var allTimeRank=allTotals.findIndex(function(x){return x.key===curKey})+1;
  var sameMonthTotals=allTotals.filter(function(x){return parseInt(x.key.split("-")[1])===curMonth});
  var monthRank=sameMonthTotals.findIndex(function(x){return x.key===curKey})+1;

  var curFYStart=fyStart(curMonth,curYear),curFYPos=fyPos(curMonth);
  var curFYKeyList=fyKeys(curFYStart,curFYPos);
  var fyTotals=curFYKeyList.map(function(k){
    var r=invByKey[k];if(!r)return{key:k,t:0};
    var t=(r.tsg||0)+(r.wll||0)+(r.nv||0);if(k===curKey)t=D.combProj;return{key:k,t:t};
  }).sort(function(a,b){return b.t-a.t});
  var fyRank=fyTotals.findIndex(function(x){return x.key===curKey})+1;

  D.rankings={fy:{r:fyRank||1,n:fyTotals.length||1},feb:{r:monthRank||1,n:sameMonthTotals.length||1},all:{r:allTimeRank||1,n:allTotals.length||1}};

  // FY Running Totals (same-point comparison)
  function fyRunningAtPoint(startYear,maxPos){
    var keys=fyKeys(startYear,maxPos),sum={tsg:0,wll:0,nv:0};
    keys.forEach(function(k){
      var r=invByKey[k];if(!r)return;
      if(k===curKey){sum.tsg+=D.tsgProj;sum.wll+=D.wllProj;sum.nv+=D.nvProj;}
      else{sum.tsg+=(r.tsg||0);sum.wll+=(r.wll||0);sum.nv+=(r.nv||0);}
    });sum.tot=sum.tsg+sum.wll+sum.nv;return sum;
  }
  function fyFullYear(startYear){
    var keys=fyKeys(startYear,11),sum=0;
    keys.forEach(function(k){var r=invByKey[k];if(r)sum+=(r.tsg||0)+(r.wll||0)+(r.nv||0);});
    return sum;
  }

  var fyMonthsIn=curFYPos+1;
  var fy0=fyRunningAtPoint(curFYStart,curFYPos);
  var fy1=fyRunningAtPoint(curFYStart-1,curFYPos);
  var fy2=fyRunningAtPoint(curFYStart-2,curFYPos);

  D.run={tsg:[fy2.tsg,fy1.tsg,fy0.tsg],wll:[fy2.wll,fy1.wll,fy0.wll],nv:[fy2.nv,fy1.nv,fy0.nv],
    tot:[fy2.tot,fy1.tot,fy0.tot],labels:[fyLabel(curFYStart-2),fyLabel(curFYStart-1),fyLabel(curFYStart)],monthsIn:fyMonthsIn};
  D.run.avg=D.run.tot.map(function(t){return fyMonthsIn>0?Math.round(t/fyMonthsIn):0;});

  // === SEASONAL PROJECTION (FIX: uses prev FY shape, not simple run-rate) ===
  // What % of prev FY total did the first N months represent?
  // Then: projected = current_running / that_percentage
  var prevFYFull=fyFullYear(curFYStart-1);
  var prevFYSamePt=fy1.tot; // prev FY at same point (Dec-Feb)
  var prev2FYFull=fyFullYear(curFYStart-2);
  var prev2FYSamePt=fy2.tot;

  // Use average of last 2 FYs' seasonal shape for robustness
  var seasonalPct=0,seasonalCount=0;
  if(prevFYFull>0&&prevFYSamePt>0){seasonalPct+=prevFYSamePt/prevFYFull;seasonalCount++;}
  if(prev2FYFull>0&&prev2FYSamePt>0){seasonalPct+=prev2FYSamePt/prev2FYFull;seasonalCount++;}
  if(seasonalCount>0)seasonalPct=seasonalPct/seasonalCount;

  D.prevFYTotal=prevFYFull;

  if(seasonalPct>0&&seasonalPct<1){
    // Seasonal projection: if first 3 months typically = X% of year, then full year = current / X%
    D.projTot=Math.round(fy0.tot/seasonalPct);
    // Split proportionally by current brand mix
    var tsgPct=fy0.tot>0?fy0.tsg/fy0.tot:0.7;
    var wllPct=fy0.tot>0?fy0.wll/fy0.tot:0.15;
    var nvPct=fy0.tot>0?fy0.nv/fy0.tot:0.05;
    D.projTsg=Math.round(D.projTot*tsgPct);
    D.projWll=Math.round(D.projTot*wllPct);
    D.projNv=Math.round(D.projTot*nvPct);
    D.projMethod="seasonal";
    D.projSeasonalPct=Math.round(seasonalPct*100);
  }else{
    // Fallback: simple run-rate (only if no historical data)
    D.projTot=fyMonthsIn>0?Math.round(fy0.tot/fyMonthsIn*12):0;
    D.projTsg=fyMonthsIn>0?Math.round(fy0.tsg/fyMonthsIn*12):0;
    D.projWll=fyMonthsIn>0?Math.round(fy0.wll/fyMonthsIn*12):0;
    D.projNv=fyMonthsIn>0?Math.round(fy0.nv/fyMonthsIn*12):0;
    D.projMethod="run-rate";
    D.projSeasonalPct=0;
  }
  D.projGrowth=D.prevFYTotal>0?po(D.projTot,D.prevFYTotal):0;

  return D;
}

// ============================================================
// RENDER
// ============================================================
function render(D){
  var h="",med=["\uD83E\uDD47","\uD83E\uDD48","\uD83E\uDD49"];

  // Header
  h+='<div class="fx-b mb-20" style="flex-wrap:wrap;gap:16px">';
  h+='<div class="fx-c"><img src="'+LOGOS.tsg+'" class="logo logo-lg"><div><h1 style="font-size:22px;font-weight:800;letter-spacing:-.03em">Revenue &amp; Invoicing</h1>';
  h+='<p style="font-size:12px;color:#6b7280;margin-top:2px">'+D.monthName+" "+D.year+" \u00B7 "+D.phase;
  if(D.monthComplete)h+=' \u00B7 <span class="pill pill-b">Month Complete</span>';
  else h+=" \u00B7 Day "+D.wdDone+" of "+D.wdTotal;
  h+="</p></div></div><div class=\"wd\">";
  for(var i=0;i<D.wdTotal;i++)h+='<div class="wd-d" style="background:'+(i<D.wdDone?"#2d6e0e":"#e5e7eb")+'"></div>';
  h+='<span class="wd-lbl">'+(D.monthComplete?"All days complete":D.wdLeft+" days left")+"</span></div></div>";

  // ==============================
  // ZONE: THE FACTS
  // ==============================
  h+='<div style="margin-bottom:16px"><div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:#9ca3af">Current Month</div><div style="font-size:16px;font-weight:700;color:#1a1a2e;margin-top:2px">The Facts \u2014 '+D.monthName+' '+D.year+'</div></div>';

  // KPIs
  h+='<div class="g4 mb-20">';
  h+='<div class="kpi" style="border-top:3px solid #CDE453"><div class="kpi-label">Combined Invoiced</div><div class="kpi-val">'+f(D.combInv)+"</div><div class=\"kpi-sub\">"+(D.combTgt?'<span class="'+(D.combInv>=D.combTgt?"up":"dn")+'">'+(D.combInv>=D.combTgt?"\u25B2":"\u25BC")+" "+ps(po(D.combInv,D.combTgt))+" vs target</span>":"")+"</div></div>";
  h+='<div class="kpi" style="border-top:3px solid #2d6e0e"><div class="kpi-label">'+(D.monthComplete?"Final Month-End":"Projected Month-End")+'</div><div class="kpi-val">'+f(D.combProj)+"</div><div class=\"kpi-sub\">"+(D.combTgt?f(D.combProj-D.combTgt)+" vs target":"")+"</div></div>";
  h+='<div class="kpi" style="border-top:3px solid #6BD4EC"><div class="kpi-label">FY Running Total</div><div class="kpi-val">'+f(D.run.tot[2])+"</div><div class=\"kpi-sub\">"+dl(po(D.run.tot[2],D.run.tot[1]))+" vs prev FY ("+D.run.monthsIn+"mo)</div></div>";
  h+='<div class="kpi" style="border-top:3px solid #FF0077"><div class="kpi-label">Avg Monthly Revenue</div><div class="kpi-val">'+f(D.run.avg[2])+"</div><div class=\"kpi-sub\">Prev FY avg: "+f(D.run.avg[1])+"</div></div>";
  h+="</div>";

  // ==============================
  // ZONE: COMPARED TO TARGETS
  // ==============================
  h+='<div style="margin:32px 0 16px;padding:8px 0;border-top:2px solid #e5e7eb"><div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:#9ca3af">Performance</div><div style="font-size:16px;font-weight:700;color:#1a1a2e;margin-top:2px">Compared to Targets</div><div style="font-size:12px;color:#6b7280;margin-top:2px">How each brand is tracking against this month\u2019s targets</div></div>';

  // === INVOICING ===
  h+='<div class="card mb-20">';
  var invDesc=D.monthComplete?"Final figures for "+D.monthName+" "+D.year:"Revenue from completed & invoiced work";
  if(!D.monthComplete)invDesc+=(D.hasWip?" \u2014 TSG assessed on WIP & confidence, WLL & NV on daily pace":" \u2014 WLL & NV pace-based projections");
  h+=secHdr("Invoicing","#1a1a2e","#fff","Monthly Invoicing",invDesc);

  // TSG
  h+='<div class="b-row" style="background:'+C.tsg.bg+";border-color:"+C.tsg.bd+'">';
  h+='<div class="b-hdr"><div class="b-name"><img src="'+LOGOS.tsg+'" class="logo"><strong>The Sign Group\u2122</strong>';
  if(D.tsgConf)h+=" "+pl(D.tsgConf)+' <span style="font-size:11px;color:#6b7280">Confidence</span>';
  h+="</div>";
  if(D.tsgTgt)h+='<div style="font-size:12px;color:#374151">Target '+f(D.tsgTgt)+" \u00B7 "+(D.tsgProj>=D.tsgTgt?'<span class="up">+'+f(D.tsgProj-D.tsgTgt)+"</span>":'<span class="dn">'+f(D.tsgProj-D.tsgTgt)+"</span>")+"</div>";
  h+="</div><div class=\"g4 mb-10\">";
  h+='<div><div class="st-label">'+(D.monthComplete?"Final Total":"Invoiced to Date")+'</div><div class="st-val">'+f(D.tsgInv)+"</div></div>";
  if(D.hasWip&&!D.monthComplete)h+='<div><div class="st-label">WIP Due This Month</div><div class="st-val" style="color:#92400e">'+f(D.tsgWipDue)+"</div></div>";
  if(!D.monthComplete)h+='<div><div class="st-label">Projected Total</div><div class="st-val" style="color:'+C.tsg.color+'">'+f(D.tsgProj)+"</div></div>";
  if(D.tsgTgt)h+='<div><div class="st-label">vs Target</div><div class="st-val" style="color:'+(D.tsgProj>=D.tsgTgt?"#16a34a":"#dc2626")+'">'+ps(po(D.tsgProj,D.tsgTgt))+"</div></div>";
  h+="</div>";if(D.tsgTgt)h+=mkbar(D.tsgInv,D.tsgTgt,C.tsg.color,D.monthComplete?null:D.tsgProj);
  if(D.hasWip||D.tsgConfNote){h+='<details class="detail-panel"><summary>Details \u2014 WIP, Notes</summary><div class="detail-content">';if(D.hasWip)h+='<div style="display:flex;gap:24px;margin-bottom:6px"><span>Undated WIP: <strong style="color:#1a1a2e">'+f(D.tsgWipUndated)+"</strong></span><span>Next Month: <strong style=\"color:#1a1a2e\">"+f(D.tsgWipNextMonth)+"</strong></span></div>";if(D.tsgConfNote)h+='<div style="font-style:italic">\uD83D\uDCA1 '+D.tsgConfNote+"</div>";h+="</div></details>";}
  h+="</div>";

  // WLL
  h+='<div class="b-row" style="background:'+C.wll.bg+";border-color:"+C.wll.bd+'">';
  h+='<div class="b-hdr"><div class="b-name"><img src="'+LOGOS.wll+'" class="logo"><strong>WeLoveLEDs\u2122</strong> '+(D.monthComplete?plb("Final","#eff6ff","#1e40af"):pl(D.wllPace))+"</div>";
  if(D.wllTgt)h+='<div style="font-size:12px;color:#374151">Target '+f(D.wllTgt)+" \u00B7 "+(D.wllProj>=D.wllTgt?'<span class="up">+'+f(D.wllProj-D.wllTgt)+"</span>":'<span class="dn">'+f(D.wllProj-D.wllTgt)+"</span>")+"</div>";
  h+="</div><div class=\"g4 mb-10\">";
  h+='<div><div class="st-label">'+(D.monthComplete?"Final Total":"Invoiced to Date")+'</div><div class="st-val">'+f(D.wllInv)+"</div></div>";
  if(!D.monthComplete){
    h+='<div><div class="st-label">Daily Rate</div><div class="st-val" style="color:'+C.wll.color+'">'+f(D.wllDaily)+'<span class="st-unit">/day</span></div></div>';
    if(D.wllNeed>0)h+='<div><div class="st-label">Needed to Hit Target</div><div class="st-val" style="color:#dc2626">'+f(D.wllNeed)+'<span class="st-unit">/day</span></div></div>';
    h+='<div><div class="st-label">Projected</div><div class="st-val" style="color:'+C.wll.color+'">'+f(D.wllProj)+"</div></div>";
  }else{if(D.wllTgt)h+='<div><div class="st-label">vs Target</div><div class="st-val" style="color:'+(D.wllInv>=D.wllTgt?"#16a34a":"#dc2626")+'">'+ps(po(D.wllInv,D.wllTgt))+"</div></div>";}
  h+="</div>";if(D.wllTgt)h+=mkbar(D.wllInv,D.wllTgt,C.wll.color,D.monthComplete?null:D.wllProj);
  if(D.wllNote){h+='<details class="detail-panel"><summary>Notes</summary><div class="detail-content">\u26A1 '+D.wllNote+"</div></details>";}
  h+="</div>";

  // NV
  h+='<div class="b-row" style="background:'+C.nv.bg+";border-color:"+C.nv.bd+'">';
  h+='<div class="b-hdr"><div class="b-name"><img src="'+LOGOS.nv+'" class="logo"><strong>Neon Vibes\u00AE</strong> '+(D.monthComplete?plb("Final","#eff6ff","#1e40af"):pl(D.nvPace))+"</div>";
  if(D.nvTgt)h+='<div style="font-size:12px;color:#374151">Target '+f(D.nvTgt)+" \u00B7 "+(D.nvProj>=D.nvTgt?'<span class="up">+'+f(D.nvProj-D.nvTgt)+"</span>":'<span class="dn">'+f(D.nvProj-D.nvTgt)+"</span>")+"</div>";
  h+="</div><div class=\"g4 mb-10\">";
  h+='<div><div class="st-label">'+(D.monthComplete?"Final Total":"Invoiced to Date")+'</div><div class="st-val">'+f(D.nvInv)+"</div></div>";
  if(!D.monthComplete){
    h+='<div><div class="st-label">Daily Rate</div><div class="st-val" style="color:'+C.nv.color+'">'+f(D.nvDaily)+'<span class="st-unit">/day</span></div></div>';
    h+='<div><div class="st-label">Projected</div><div class="st-val" style="color:'+C.nv.color+'">'+f(D.nvProj)+"</div></div>";
  }
  if(D.nvTgt)h+='<div><div class="st-label">vs Target</div><div class="st-val" style="color:'+(D.nvProj>=D.nvTgt?"#16a34a":"#dc2626")+'">'+ps(po(D.nvProj,D.nvTgt))+"</div></div>";
  h+="</div>";if(D.nvTgt)h+=mkbar(D.nvInv,D.nvTgt,C.nv.color,D.monthComplete?null:D.nvProj);
  if(D.nvNote){h+='<details class="detail-panel"><summary>Notes</summary><div class="detail-content">'+D.nvNote+"</div></details>";}
  h+="</div>";

  // Combined
  h+='<div class="comb fx-b" style="flex-wrap:wrap;gap:8px"><div class="fx-c"><span style="font-weight:700;font-size:11px;color:#6b7280;text-transform:uppercase;letter-spacing:.5px">Combined</span><span style="font-size:20px;font-weight:800">'+f(D.combInv)+"</span>";
  if(!D.monthComplete)h+='<span style="color:#9ca3af;font-size:14px">\u2192</span><span style="font-size:16px;font-weight:700;color:#92400e">'+f(D.combProj)+'</span><span style="font-size:12px;color:#6b7280">projected</span>';
  h+="</div>";if(D.combTgt)h+='<div style="font-size:12px;color:#374151">Target: '+f(D.combTgt)+' \u00B7 <span class="'+(D.combProj>=D.combTgt?"up":"dn")+'">'+f(D.combProj-D.combTgt)+"</span></div>";
  h+="</div></div>";

  // ==============================
  // ZONE: COMPARED TO PREVIOUS YEARS
  // ==============================
  h+='<div style="margin:32px 0 16px;padding:8px 0;border-top:2px solid #e5e7eb"><div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:#9ca3af">For Reference</div><div style="font-size:16px;font-weight:700;color:#1a1a2e;margin-top:2px">Compared to Previous Years</div></div>';

  // Historical Chart
  h+='<div class="card mb-20"><div style="margin-bottom:16px"><span class="sec-pill" style="background:#6BD4EC;color:#1a1a2e">Historical</span><div class="sec-title">Monthly Revenue \u2014 Last 12 Months</div><div class="sec-sub">Combined invoiced revenue by month with target line</div></div>';
  h+='<canvas id="histChart" style="width:100%;max-height:300px"></canvas></div>';

  // Rankings & FY Running
  h+='<div class="g2 mb-20">';
  h+='<div class="card">';
  h+=secHdr("Rankings","#FADD3E","#1a1a2e",D.month+" Rankings & History","How this "+D.monthName+" compares historically");
  h+='<div class="g3 mb-16">';
  [{l:"This FY",r:D.rankings.fy.r,s:"of "+D.rankings.fy.n+" months"},{l:"All "+D.month+"s",r:D.rankings.feb.r,s:"of "+D.rankings.feb.n+" "+D.monthName+"s"},{l:"All Time",r:D.rankings.all.r,s:"of "+D.rankings.all.n+" months"}].forEach(function(r){
    h+='<div class="rk"><div class="rk-l">'+r.l+'</div><div class="rk-v" style="color:'+(r.r<=3?"#92400e":"#6b7280")+'">'+(r.r<=3?med[r.r-1]:"")+" #"+r.r+'</div><div class="rk-s">'+r.s+"</div></div>";
  });h+="</div>";
  if(D.histMonth.length>0){
    var mx=Math.max.apply(null,D.histMonth.map(function(x){return x.v||x.t}));
    h+='<div style="font-size:11px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-bottom:6px">'+D.monthName+" Turnover</div>";
    h+=hbar(D.histMonth,mx*1.05,"#92400e",false);
    h+='<details class="detail-panel mt-12"><summary>Brand Split by Year</summary><div style="margin-top:8px"><table class="tbl"><thead><tr><th>Year</th><th style="color:'+C.tsg.color+'">TSG</th><th style="color:'+C.wll.color+'">WLL</th><th style="color:'+C.nv.color+'">NV</th><th style="color:#374151">Total</th></tr></thead><tbody>';
    D.histMonth.forEach(function(x){h+='<tr class="'+(x.h||x.p?"hl":"")+'"><td>'+x.l+"</td><td>"+f(x.tsg)+"</td><td>"+f(x.wll)+"</td><td>"+f(x.nv)+'</td><td style="font-weight:600">'+f(x.v||x.t)+"</td></tr>";});
    h+="</tbody></table></div></details>";
  }
  h+="</div>";

  // FY Running
  h+='<div class="card">';
  h+=secHdr("Financial Year","#6BD4EC","#1a1a2e","Running Totals","vs previous FYs at the same point ("+D.run.monthsIn+" months: Dec\u2013"+D.month+")");
  [{n:"The Sign Group\u2122",lg:LOGOS.tsg,c:C.tsg.color,d:D.run.tsg},{n:"WeLoveLEDs\u2122",lg:LOGOS.wll,c:C.wll.color,d:D.run.wll},{n:"Neon Vibes\u00AE",lg:LOGOS.nv,c:C.nv.color,d:D.run.nv},{n:"Combined",lg:null,c:"#1a1a2e",d:D.run.tot}].forEach(function(r){
    if(!r.d[2]&&!r.d[1])return;
    var vp=r.d[1]?po(r.d[2],r.d[1]):0;
    h+='<div class="rt"><div class="fx-b" style="margin-bottom:6px"><div class="fx-c">';
    if(r.lg)h+='<img src="'+r.lg+'" style="width:20px;height:20px;object-fit:contain;border-radius:4px">';
    else h+='<div style="width:8px;height:8px;border-radius:50%;background:'+r.c+'"></div>';
    h+='<span style="font-weight:600;font-size:13px;color:#1a1a2e">'+r.n+"</span></div><span style=\"font-size:18px;font-weight:700;color:#1a1a2e\">"+f(r.d[2])+"</span></div>";
    var barMax=Math.max(r.d[0]||1,r.d[1]||1,r.d[2]||1)*1.1;
    h+='<div class="bar-w" style="height:5px"><div class="bar-f" style="width:'+Math.min(r.d[2]/barMax*100,100)+"%;background:"+r.c+'"></div></div>';
    if(r.d[1])h+='<div style="margin-top:5px;font-size:12px;color:#6b7280">vs prev FY: '+f(r.d[1])+" "+dl(vp)+"</div>";
    h+="</div>";
  });
  h+='<details class="detail-panel mt-8"><summary>Full Comparison ('+D.run.monthsIn+' months into each FY)</summary><div style="margin-top:8px"><table class="tbl"><thead><tr><th></th>';
  D.run.labels.forEach(function(x){h+="<th>"+x+"</th>";});
  h+="</tr></thead><tbody>";
  [["TSG",D.run.tsg],["WLL",D.run.wll],["NV",D.run.nv],["Total",D.run.tot],["Avg/Mo",D.run.avg]].forEach(function(row,i){
    h+='<tr class="'+(i>=3?"bold":"")+'"><td>'+row[0]+"</td>";row[1].forEach(function(v){h+="<td>"+f(v)+"</td>";});h+="</tr>";
  });
  h+="</tbody></table></div></details></div></div>";

  // ==============================
  // ZONE: NEW SALES ORDERS (Simplified)
  // ==============================
  if(D.nsVal>0||D.nsEnq>0||D.nsOrd>0||D.nsHistory.length>0){
    h+='<div style="margin:32px 0 16px;padding:8px 0;border-top:2px solid #e5e7eb"><div style="font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:#9ca3af">Order Intake</div><div style="font-size:16px;font-weight:700;color:#1a1a2e;margin-top:2px">New Sales Orders \u2014 TSG</div><div style="font-size:12px;color:#6b7280;margin-top:2px">Summary only \u2014 full detail on the <a href="/" style="color:#2563eb;font-weight:600">Sales Performance</a> page</div></div>';

    h+='<div class="ns mb-20"><div style="display:flex;flex-wrap:wrap;gap:20px;align-items:center">';
    // Value
    if(D.nsVal>0){
      h+='<div><div style="font-size:36px;font-weight:800;color:#CDE453;letter-spacing:-.03em;line-height:1">'+f(D.nsVal)+"</div>";
      if(D.nsTgt)h+='<div style="font-size:12px;color:#94a3b8;margin-top:4px">Target: '+f(D.nsTgt);
      if(D.nsTgt&&D.nsVal>=D.nsTgt)h+=' \u00B7 <span style="color:#4ade80;font-weight:700">+'+f(D.nsVal-D.nsTgt)+" above</span>";
      if(D.nsTgt)h+="</div>";
      h+="</div>";
    }
    // Key stats
    h+='<div style="display:flex;gap:24px">';
    h+='<div class="ns-glass" style="padding:12px 18px"><div style="font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px">Enquiries</div><div style="font-size:24px;font-weight:800;color:#fff">'+D.nsEnq+"</div></div>";
    h+='<div class="ns-glass" style="padding:12px 18px"><div style="font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px">Orders</div><div style="font-size:24px;font-weight:800;color:#fff">'+D.nsOrd+"</div></div>";
    h+='<div class="ns-glass" style="padding:12px 18px"><div style="font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px">Conversion</div><div style="font-size:24px;font-weight:800;color:#6BD4EC">'+D.nsConv+"%</div></div>";
    if(D.nsAov>0)h+='<div class="ns-glass" style="padding:12px 18px"><div style="font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px">AOV</div><div style="font-size:24px;font-weight:800;color:#fff">'+f(D.nsAov)+"</div></div>";
    h+="</div></div></div>";
  }

  // === Projections & Focus ===
  h+='<div class="g2 mb-20">';

  // Projected Annual — with seasonal explanation
  h+='<div class="card">';
  h+=secHdr("Projections","#FF0077","#fff","Projected Annual Sales","Full year projection for "+D.run.labels[2]);
  h+='<div style="text-align:center;padding:8px 0;margin-bottom:20px">';
  h+='<div style="font-size:36px;font-weight:800;color:#1a1a2e;letter-spacing:-.03em">'+f(D.projTot)+"</div>";
  if(D.projMethod==="seasonal"){
    h+='<div style="font-size:12px;color:#6b7280;margin-top:3px">Seasonally weighted \u2014 Dec\u2013'+D.month+" historically represents ~"+D.projSeasonalPct+"% of a full year</div>";
  }else{
    h+='<div style="font-size:12px;color:#6b7280;margin-top:3px">Based on '+D.run.monthsIn+" months (run-rate, no seasonal data)</div>";
  }
  if(D.prevFYTotal)h+='<div style="font-size:12px;color:#6b7280;margin-top:2px">Prev FY total: '+f(D.prevFYTotal)+"</div>";
  if(D.projGrowth)h+='<div style="font-size:14px;font-weight:700;color:'+(D.projGrowth>=0?"#16a34a":"#dc2626")+';margin-top:4px">'+ps(D.projGrowth)+" vs last year</div>";
  h+="</div>";
  [{n:"The Sign Group\u2122",lg:LOGOS.tsg,v:D.projTsg},{n:"WeLoveLEDs\u2122",lg:LOGOS.wll,v:D.projWll},{n:"Neon Vibes\u00AE",lg:LOGOS.nv,v:D.projNv}].forEach(function(r){
    h+='<div class="fx-b" style="padding:10px 0;border-bottom:1px solid #f3f4f6"><div class="fx-c"><img src="'+r.lg+'" style="width:20px;height:20px;object-fit:contain;border-radius:4px"><span style="font-weight:600;font-size:13px;color:#1a1a2e">'+r.n+"</span></div><span style=\"font-size:16px;font-weight:700;color:#1a1a2e\">"+f(r.v)+"</span></div>";
  });
  h+="</div>";

  // Focus
  h+='<div class="card" style="display:flex;flex-direction:column">';
  h+=secHdr("This Week","#CDE453","#1a1a2e","Sales Focus \u2014 "+D.phase,"Priority action for the sales team");
  if(D.focus)h+='<div style="background:'+C.tsg.bg+";border:1px solid "+C.tsg.bd+';border-radius:8px;padding:16px;margin-bottom:16px"><p style="font-size:14px;color:#1a1a2e;line-height:1.6;font-weight:500">'+D.focus+"</p></div>";
  if(D.optFocus)h+='<div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:12px 14px;margin-bottom:16px"><div style="font-size:10px;color:#6b7280;text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px;font-weight:600">Also Worth Noting</div><p style="font-size:13px;color:#374151;line-height:1.5">'+D.optFocus+"</p></div>";
  h+='<div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:12px 14px;margin-top:auto"><div style="font-size:11px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px">Month at a Glance</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">';
  if(D.combTgt)h+='<div class="gl-r"><span>Invoicing vs Target</span><span class="'+(D.combProj>=D.combTgt?"up":"dn")+'">'+ps(po(D.combProj,D.combTgt))+"</span></div>";
  if(D.nsTgt&&D.nsVal)h+='<div class="gl-r"><span>New Orders vs Target</span><span class="'+(D.nsVal>=D.nsTgt?"up":"dn")+'">'+ps(po(D.nsVal,D.nsTgt))+"</span></div>";
  h+='<div class="gl-r"><span>'+D.month+' Rank (All '+D.month+'s)</span><span style="font-weight:600;color:#92400e">'+(D.rankings.feb.r<=3?med[D.rankings.feb.r-1]:"")+" #"+D.rankings.feb.r+"</span></div>";
  if(D.nsConv)h+='<div class="gl-r"><span>Conversion Rate</span><span class="up">'+D.nsConv+"%</span></div>";
  h+="</div></div></div></div>";

  // Footer
  h+='<div class="footer">';
  if(D.monthComplete)h+=D.monthName+" "+D.year+" \u2014 month-end figures";
  else h+=D.monthName+" "+D.year+" figures are projections until month-end close \u00B7 "+(D.hasWip?"TSG assessed on WIP & confidence, ":"")+"WLL & NV assessed on daily pace";
  h+="<br>The Sign Group\u2122 \u00B7 WeLoveLEDs\u2122 \u00B7 Neon Vibes\u00AE</div>";

  document.getElementById("app").innerHTML=h;

  // === Build Historical Chart ===
  buildHistChart(D);
}

function buildHistChart(D){
  var el=document.getElementById("histChart");
  if(!el)return;
  // Use histMonth data to build a bar chart of monthly totals
  var labels=D.histMonth.map(function(x){return x.l});
  var totals=D.histMonth.map(function(x){return x.v||x.t});
  var tsgVals=D.histMonth.map(function(x){return x.tsg});
  var wllVals=D.histMonth.map(function(x){return x.wll});
  var nvVals=D.histMonth.map(function(x){return x.nv});
  var bgColors=D.histMonth.map(function(x){return x.h?"#1a1a2e":"#d1d5db"});
  var borderColors=D.histMonth.map(function(x){return x.h?"#1a1a2e":"#9ca3af"});

  new Chart(el.getContext("2d"),{
    type:"bar",
    data:{
      labels:labels,
      datasets:[
        {label:"TSG",data:tsgVals,backgroundColor:D.histMonth.map(function(x){return x.h?C.tsg.color:"rgba(45,110,14,0.3)"}),borderRadius:2,stack:"revenue"},
        {label:"WLL",data:wllVals,backgroundColor:D.histMonth.map(function(x){return x.h?C.wll.color:"rgba(8,145,178,0.3)"}),borderRadius:2,stack:"revenue"},
        {label:"NV",data:nvVals,backgroundColor:D.histMonth.map(function(x){return x.h?C.nv.color:"rgba(255,0,119,0.3)"}),borderRadius:2,stack:"revenue"},
      ]
    },
    options:{
      responsive:true,maintainAspectRatio:true,aspectRatio:2.5,
      plugins:{legend:{display:true,position:"top",labels:{usePointStyle:true,padding:16,font:{family:"Inter",size:12}}}},
      scales:{
        y:{beginAtZero:true,stacked:true,grid:{color:"#e5e7eb"},ticks:{font:{family:"Inter",size:11},callback:function(v){return"\u00A3"+Math.round(v/1000)+"k"}}},
        x:{stacked:true,grid:{display:false},ticks:{font:{family:"Inter",size:11}}}
      }
    }
  });
}

// ============================================================
async function init(){
  try{
    var res=await fetch("/sales-data");
    if(!res.ok)throw new Error("API returned "+res.status);
    var raw=await res.json();if(raw.error)throw new Error(raw.error);
    if(raw.debugFields){
      console.group("Airtable Field Names");
      console.log("Overview:",raw.debugFields.overview);
      console.log("Invoiced:",raw.debugFields.invoiced);
      console.log("Conversions:",raw.debugFields.conversions);
      console.groupEnd();
      if(raw.conversions.length>0)console.log("Latest conversions:",raw.conversions[raw.conversions.length-1]);
    }
    document.getElementById("loading").style.display="none";
    var D=processData(raw);render(D);
    if(raw.lastFetched){var ft=new Date(raw.lastFetched);document.getElementById("navUpdated").textContent="Live \u2022 "+ft.toLocaleString("en-GB",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});}
  }catch(err){
    document.getElementById("loading").style.display="none";
    document.getElementById("error").innerHTML='<div class="error-box"><strong>Failed to load data</strong><br><br>'+err.message+"</div>";
  }
}
init();
</script>
</body>
</html>
